<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è·‘æ­¥è®­ç»ƒæµç¨‹æ§åˆ¶å™¨</title>
<style>
  :root {
    --primary: #3b82f6;
    --active-bg: #eff6ff;
    --text-main: #0f172a;
    --text-sub: #64748b;
    --sidebar-w: 260px;
  }

  body {
    font-family: 'Inter', system-ui, sans-serif;
    margin: 0;
    background-color: #f8fafc;
    height: 100vh;
    display: flex;
    overflow: hidden; /* é˜²æ­¢æ•´ä½“æ»šåŠ¨ */
  }

  /* === å¸ƒå±€ === */
  #app-container {
    display: flex;
    width: 100%;
    height: 100%;
  }

  /* ä¾§è¾¹æ  */
  #sidebar {
    width: var(--sidebar-w);
    background: white;
    border-right: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    z-index: 10;
  }

  .category-tabs {
    display: flex;
    padding: 10px;
    gap: 5px;
    background: #fff;
    border-bottom: 1px solid #e2e8f0;
  }

  .tab-btn {
    flex: 1;
    padding: 8px 4px;
    font-size: 12px;
    border: 1px solid #e2e8f0;
    background: #f1f5f9;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-sub);
  }
  .tab-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  #playlist {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .playlist-item {
    padding: 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid transparent;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
  }

  .playlist-item:hover { background: #f8fafc; }
  
  .playlist-item.active {
    background: var(--active-bg);
    border-color: #bfdbfe;
  }
  
  .playlist-item.done { opacity: 0.5; }

  .item-name { font-size: 14px; font-weight: 600; color: var(--text-main); }
  .item-time { font-size: 12px; color: var(--text-sub); }

  /* ä¸»è§†å›¾ */
  #main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 20px;
    /* background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); */
  }

  /* è®¡æ—¶å™¨å¡ç‰‡ */
  #timer-card {
    background: white;
    padding: 40px;
    border-radius: 30px;
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
    text-align: center;
    width: 100%;
    max-width: 400px;
    transition: transform 0.3s ease;
  }

  /* çŠ¶æ€æŒ‡ç¤º */
  .status-tag {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 20px;
    background: #e2e8f0; color: #475569;
  }
  .status-tag.work { background: #dbeafe; color: #1e40af; }
  .status-tag.rest { background: #dcfce7; color: #166534; }

  #current-action { font-size: 32px; font-weight: 800; margin: 0 0 10px 0; line-height: 1.1; color: var(--text-main); }
  #current-detail { font-size: 18px; color: var(--primary); font-weight: 500; min-height: 27px; }

  #display {
    font-size: 96px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    letter-spacing: -4px;
    margin: 10px 0;
    color: var(--text-main);
  }

  .controls {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }

  .btn {
    border: none;
    padding: 16px 24px;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    flex: 1;
    transition: transform 0.1s;
    display: flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.95); }
  .btn-primary { background: var(--text-main); color: white; flex: 2; }
  .btn-sec { background: #f1f5f9; color: var(--text-main); }

  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 768px) {
    #app-container { flex-direction: column-reverse; }
    #sidebar { width: 100%; height: 40%; border-right: none; border-top: 1px solid #e2e8f0; }
    #main-view { height: 60%; }
    #timer-card { padding: 20px; box-shadow: none; background: transparent; }
    #display { font-size: 72px; }
    #current-action { font-size: 24px; }
  }
</style>
</head>
<body>

<div id="app-container">
  <!-- å·¦ä¾§ï¼šæ’­æ”¾åˆ—è¡¨ä¸åˆ†ç±» -->
  <div id="sidebar">
    <div class="category-tabs">
      <button class="tab-btn" onclick="app.loadCategory('activation')">ğŸ”¥ è·‘å‰æ¿€æ´»</button>
      <button class="tab-btn active" onclick="app.loadCategory('stretch')">ğŸ§˜ è·‘åæ‹‰ä¼¸</button>
      <button class="tab-btn" onclick="app.loadCategory('strength')">ğŸ’ª åŠ›é‡å¼ºåŒ–</button>
    </div>
    <div id="playlist">
      <!-- JS åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <!-- å³ä¾§ï¼šè®¡æ—¶å™¨ -->
  <div id="main-view">
    <div id="timer-card">
      <div id="status-tag" class="status-tag">å‡†å¤‡</div>
      <h1 id="current-action">é€‰æ‹©æ¨¡å¼</h1>
      <div id="current-detail">ç‚¹å‡»å·¦ä¾§åˆ—è¡¨å¼€å§‹</div>
      <div id="display">00.0</div>
      
      <div class="controls">
        <button class="btn btn-sec" onclick="app.skip(-1)">â®</button>
        <button class="btn btn-primary" id="toggle-btn" onclick="app.toggle()">å¼€å§‹</button>
        <button class="btn btn-sec" onclick="app.skip(1)">â­</button>
      </div>
      <div style="margin-top:15px; font-size:12px; color:#94a3b8; cursor:pointer;" onclick="app.reset()">æŒ‰ R é‡ç½®</div>
    </div>
  </div>
</div>

<script>
const app = (function() {
  // === æ•°æ®é…ç½® ===
  const DATA = {
    // 1. è·‘å‰æ¿€æ´» (åŠ¨æ€ï¼Œæ—¶é—´çŸ­ï¼Œå°‘ä¼‘æ¯)
    activation: {
      work: 30, rest: 5,
      items: [
        { name: "èšŒå¼å¼€åˆ", detail: "å·¦ä¾§" },
        { name: "èšŒå¼å¼€åˆ", detail: "å³ä¾§" },
        { name: "é å¢™é™è¹²", detail: "" },
      ]
    },
    // 2. è·‘åæ‹‰ä¼¸ (é™æ€ï¼Œæ—¶é—´é•¿ï¼Œä¸­ç­‰ä¼‘æ¯)
    stretch: {
      work: 45, rest: 10,
      items: [
        { name: "è‚¡å››å¤´è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å¤§è…¿å‰ä¾§)" },
        { name: "è‚¡å››å¤´è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å¤§è…¿å‰ä¾§)" },
        { name: "èƒ­ç»³è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å¤§è…¿åä¾§)" },
        { name: "èƒ­ç»³è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å¤§è…¿åä¾§)" },
        { name: "ITB é«‚èƒ«æŸ", detail: "å·¦ä¾§ (åŒè„šäº¤å‰)" },
        { name: "ITB é«‚èƒ«æŸ", detail: "å³ä¾§ (åŒè„šäº¤å‰)" },
        { name: "è…“è‚ è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å°è…¿åä¾§ç›´è…¿)" },
        { name: "è…“è‚ è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å°è…¿åä¾§ç›´è…¿)" },
        { name: "æ¯”ç›®é±¼è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å°è…¿åä¾§å±ˆè†)" },
        { name: "æ¯”ç›®é±¼è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å°è…¿åä¾§å±ˆè†)" }
      ]
    },
    // 3. åŠ›é‡å¼ºåŒ– (æ—¶é—´é•¿ï¼Œä¼‘æ¯å……è¶³)
    strength: {
      work: 50, rest: 15,
      items: [
        { name: "é å¢™é™è¹² 1", detail: "" },
        { name: "é å¢™é™è¹² 2", detail: "" },
        { name: "é å¢™é™è¹² 3", detail: "" },
      ]
    }
  };

  // === çŠ¶æ€å˜é‡ ===
  let currentCategory = 'stretch';
  let queue = []; // æ‰§è¡Œé˜Ÿåˆ—
  let cursor = 0; // å½“å‰é˜Ÿåˆ—ç´¢å¼•
  let timeLeft = 0;
  let isRunning = false;
  let rafId = null;
  let lastTime = null;
  let audioCtx = null;

  // === DOM å¼•ç”¨ ===
  const els = {
    playlist: document.getElementById('playlist'),
    tabs: document.querySelectorAll('.tab-btn'),
    display: document.getElementById('display'),
    action: document.getElementById('current-action'),
    detail: document.getElementById('current-detail'),
    tag: document.getElementById('status-tag'),
    btnToggle: document.getElementById('toggle-btn')
  };

  // === åˆå§‹åŒ– ===
  function init() {
    loadCategory('activation');
    setupAudio();
  }

  // === æ ¸å¿ƒé€»è¾‘ï¼šåŠ è½½åˆ†ç±» ===
  function loadCategory(key) {
    currentCategory = key;
    
    // æ›´æ–° Tab æ ·å¼
    els.tabs.forEach(t => t.classList.remove('active'));
    // ç®€å•ç²—æš´æ‰¾å¯¹åº”tab
    const targetTab = Array.from(els.tabs).find(t => t.textContent.includes(key === 'activation' ? 'æ¿€æ´»' : key === 'stretch' ? 'æ‹‰ä¼¸' : 'å¼ºåŒ–'));
    if(targetTab) targetTab.classList.add('active');

    // æ„å»ºé˜Ÿåˆ—
    // ç»“æ„: [Prep] -> [Work] -> [Rest] -> [Work] ... -> [Finish]
    const cfg = DATA[key];
    queue = [];
    queue.push({ type: 'prep', name: 'å‡†å¤‡å¼€å§‹', detail: 'è°ƒæ•´å‘¼å¸', duration: 3, refIndex: -1 });
    
    cfg.items.forEach((item, idx) => {
      // Work
      queue.push({ 
        type: 'work', 
        name: item.name, 
        detail: item.detail, 
        duration: cfg.work, 
        refIndex: idx, // å¯¹åº”ä¾§è¾¹æ çš„ç´¢å¼•
        total: cfg.items.length 
      });
      // Rest (æœ€åä¸€ä¸ªåŠ¨ä½œåä¸éœ€è¦ä¼‘æ¯ï¼Œç›´æ¥ç»“æŸ)
      if (idx < cfg.items.length - 1) {
        queue.push({ 
          type: 'rest', 
          name: 'ä¼‘æ¯ / ä¸‹ä¸€ä¸ª', 
          detail: `Next: ${cfg.items[idx+1].name}`, 
          duration: cfg.rest,
          refIndex: idx // ä¼‘æ¯æ—¶é«˜äº®ä¸Šä¸€ä¸ªå®Œæˆçš„ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªå¾…åŠçš„ï¼Ÿé€šå¸¸é«˜äº®å³å°†è¿›è¡Œçš„
        });
      }
    });
    
    queue.push({ type: 'finish', name: 'è®­ç»ƒå®Œæˆ', detail: 'Nice Work!', duration: 0, refIndex: -1 });

    // é‡ç½®çŠ¶æ€
    cursor = 0;
    isRunning = false;
    timeLeft = queue[0].duration;
    cancelAnimationFrame(rafId);
    
    renderPlaylist();
    renderUI();
  }

  // === æ ¸å¿ƒé€»è¾‘ï¼šæ¸²æŸ“æ’­æ”¾åˆ—è¡¨ ===
  function renderPlaylist() {
    const items = DATA[currentCategory].items;
    els.playlist.innerHTML = items.map((item, idx) => `
      <div class="playlist-item" id="pl-item-${idx}" onclick="app.jumpTo(${idx})">
        <div>
          <div class="item-name">${idx + 1}. ${item.name}</div>
          <div class="item-time">${item.detail}</div>
        </div>
        <div style="font-size:12px; color:#cbd5e1">${DATA[currentCategory].work}s</div>
      </div>
    `).join('');
  }

  // === æ ¸å¿ƒé€»è¾‘ï¼šè·³è½¬ä¸æ§åˆ¶ ===
  
  // ç‚¹å‡»ä¾§è¾¹æ æŸä¸€é¡¹
  function jumpTo(itemIndex) {
    // åœ¨é˜Ÿåˆ—ä¸­æ‰¾åˆ°è¯¥ item çš„ 'work' é˜¶æ®µ
    const qIndex = queue.findIndex(q => q.type === 'work' && q.refIndex === itemIndex);
    if (qIndex !== -1) {
      cursor = qIndex;
      timeLeft = queue[cursor].duration;
      // **å…³é”®éœ€æ±‚**ï¼šæ‰‹åŠ¨ç‚¹å‡»ç›´æ¥å¼€å§‹ï¼Œä¸è¦æš‚åœ
      if (!isRunning) start();
      else lastTime = performance.now(); // é‡ç½®ä¸Šä¸€å¸§æ—¶é—´é˜²æ­¢è·³å˜
      
      // å£°éŸ³åé¦ˆ
      speak(queue[cursor].name + " " + queue[cursor].detail);
      renderUI();
    }
  }

  // ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª (Skip)
  function skip(direction) {
    let newCursor = cursor + direction;
    
    // é€»è¾‘ä¼˜åŒ–ï¼šæ‰‹åŠ¨è·³è¿‡æ—¶ï¼Œå¦‚æœæ˜¯ä¼‘æ¯ï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ª Workï¼›å¦‚æœæ˜¯Workï¼Œè·³åˆ°ä¼‘æ¯
    // å¦‚æœç”¨æˆ·æŒ‰ "Next" (direction=1)
    if (direction === 1) {
       // é˜²æ­¢è¶Šç•Œ
       if (newCursor >= queue.length) return;
       // ç«‹å³æ‰§è¡Œä¸‹ä¸€é¡¹
       cursor = newCursor;
       timeLeft = queue[cursor].duration;
       if (!isRunning) start();
    } 
    // å¦‚æœç”¨æˆ·æŒ‰ "Prev"
    else {
      if (newCursor < 0) return;
      // å¦‚æœå½“å‰æ˜¯Workï¼Œå¾€å›è·³é€šå¸¸æ˜¯æƒ³é‡åšä¸Šä¸€ä¸ªï¼Œæˆ–è€…å›åˆ°ä¸Šä¸€ä¸ªä¼‘æ¯
      // ç®€åŒ–é€»è¾‘ï¼šç›´æ¥é€€ä¸€æ­¥
      cursor = newCursor;
      timeLeft = queue[cursor].duration;
    }
    renderUI();
  }

  function toggle() {
    if (queue[cursor].type === 'finish') return;
    initAudioContext(); // ç¡®ä¿éŸ³é¢‘è§£é”
    if (isRunning) pause(); else start();
  }

  function start() {
    if (isRunning) return;
    isRunning = true;
    lastTime = performance.now();
    rafId = requestAnimationFrame(tick);
    renderUI();
  }

  function pause() {
    isRunning = false;
    cancelAnimationFrame(rafId);
    renderUI();
  }

  function reset() {
    loadCategory(currentCategory);
  }

  // === è®¡æ—¶å¾ªç¯ ===
  function tick() {
    if (!isRunning) return;
    const now = performance.now();
    const delta = (now - lastTime) / 1000;
    lastTime = now;

    if (timeLeft > 0) {
      const prev = timeLeft;
      timeLeft -= delta;
      
      // å€’è®¡æ—¶ 3-2-1
      if (Math.ceil(timeLeft) <= 3 && Math.ceil(prev) > Math.ceil(timeLeft) && timeLeft > 0) {
        playBeep(600, 0.1); 
      }
      
      renderUI();
      rafId = requestAnimationFrame(tick);
    } else {
      // ç¯èŠ‚ç»“æŸï¼Œè‡ªåŠ¨ä¸‹ä¸€æ­¥
      autoNext();
    }
  }

  function autoNext() {
    if (cursor >= queue.length - 1) {
      cursor = queue.length - 1; // åœåœ¨ finish
      pause();
      playWin();
      renderUI();
      return;
    }

    cursor++;
    const step = queue[cursor];
    timeLeft = step.duration;
    
    // å£°éŸ³ä¸æç¤º
    if (step.type === 'work') {
      playBeep(440, 0.3); // å¼€å§‹åŠ¨ä½œ
      speak(step.name);
    } else if (step.type === 'rest') {
      playBeep(880, 0.1); // å¼€å§‹ä¼‘æ¯
      speak("ä¼‘æ¯ã€‚ä¸‹ä¸€ä¸ªï¼š" + queue[cursor+1].name);
    }

    renderUI();
    // ä¿æŒè¿è¡Œ
    lastTime = performance.now();
    rafId = requestAnimationFrame(tick);
  }

  // === UI æ¸²æŸ“ ===
  function renderUI() {
    const step = queue[cursor];
    
    // 1. æ–‡æœ¬ä¸é¢œè‰²
    els.display.innerText = Math.max(0.0, timeLeft).toFixed(1);
    els.action.innerText = step.name;
    els.detail.innerText = step.detail;
    els.btnToggle.innerText = isRunning ? "æš‚åœ (Space)" : (step.type === 'finish' ? "ç»“æŸ" : "å¼€å§‹");
    
    // 2. çŠ¶æ€æ ·å¼
    document.body.style.background = step.type === 'rest' ? '#f0fdf4' : '#f8fafc'; // ä¼‘æ¯æ—¶å…¨å±å˜ç»¿
    if (step.type === 'work') {
      els.tag.className = 'status-tag work';
      els.tag.innerText = `è¿›è¡Œä¸­ ${step.refIndex+1}/${step.total}`;
      els.display.style.color = '#0f172a';
    } else if (step.type === 'rest') {
      els.tag.className = 'status-tag rest';
      els.tag.innerText = 'ä¼‘æ¯ / æ¢åŠ¨ä½œ';
      els.display.style.color = '#166534';
    } else {
      els.tag.className = 'status-tag';
      els.tag.innerText = step.type === 'prep' ? 'å‡†å¤‡' : 'å®Œæˆ';
    }

    // 3. ä¾§è¾¹æ é«˜äº®
    // æ¸…é™¤æ—§çš„
    document.querySelectorAll('.playlist-item').forEach(d => {
        d.classList.remove('active');
        d.classList.remove('done');
    });
    
    // é«˜äº®å½“å‰
    // å¦‚æœæ˜¯ Restï¼Œæˆ‘ä»¬é«˜äº®ä¸‹ä¸€ä¸ªåŠ¨ä½œä½œä¸ºé¢„å‘Šï¼Ÿè¿˜æ˜¯ä¿æŒä¸Šä¸€ä¸ªï¼Ÿ
    // é€»è¾‘ï¼šå¦‚æœæ˜¯ Workï¼Œé«˜äº®å½“å‰ refIndexã€‚å¦‚æœæ˜¯ Restï¼Œä¹Ÿå¯ä»¥é«˜äº®ä¸‹ä¸€ä¸ª(cursor+1)çš„ refIndex
    let targetIdx = -1;
    if (step.type === 'work') targetIdx = step.refIndex;
    else if (step.type === 'rest') targetIdx = queue[cursor+1].refIndex;
    
    if (targetIdx !== -1) {
       const el = document.getElementById(`pl-item-${targetIdx}`);
       if (el) {
           el.classList.add('active');
           // ç¡®ä¿æ»šåŠ¨å¯è§
           el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
       }
    }
    
    // æ ‡è®°å·²å®Œæˆ
    for(let i=0; i<targetIdx; i++) {
        const el = document.getElementById(`pl-item-${i}`);
        if(el) el.classList.add('done');
    }
  }

  // === éŸ³é¢‘ç³»ç»Ÿ ===
  function setupAudio() {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
  }
  
  function initAudioContext() {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function playBeep(freq, dur) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + dur);
    osc.stop(audioCtx.currentTime + dur);
  }

  function playWin() {
    if (!audioCtx) return;
    [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playBeep(f, 0.2), i*150));
    speak("è®­ç»ƒå®Œæˆ");
  }

  function speak(txt) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(txt);
      msg.lang = 'zh-CN';
      msg.rate = 1.2;
      window.speechSynthesis.speak(msg);
    }
  }

  // === é”®ç›˜ç›‘å¬ ===
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); toggle(); }
    else if (e.code === 'ArrowRight') skip(1);
    else if (e.code === 'ArrowLeft') skip(-1);
    else if (e.key.toLowerCase() === 'r') reset();
  });

  // å¯åŠ¨
  init();

  // æš´éœ²ç»™ HTML çš„æ¥å£
  return { loadCategory, jumpTo, toggle, skip, reset };
})();
</script>
</body>
</html>