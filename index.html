<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è·‘æ­¥è®­ç»ƒæµç¨‹æ§åˆ¶å™¨</title>
<link rel="icon" type="image/png" href="/favicon.png">
<style>
  :root {
    --primary: #3b82f6;
    --active-bg: #eff6ff;
    --text-main: #0f172a;
    --text-sub: #64748b;
    --sidebar-w: 260px;
  }

  body {
    font-family: 'Inter', system-ui, sans-serif;
    margin: 0;
    background-color: #f8fafc;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* === å¸ƒå±€ === */
  #app-container {
    display: flex;
    width: 100%;
    height: 100%;
  }

  /* ä¾§è¾¹æ  */
  #sidebar {
    width: var(--sidebar-w);
    background: white;
    border-right: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    z-index: 10;
  }

  .category-tabs {
    display: flex;
    padding: 10px;
    gap: 5px;
    background: #fff;
    border-bottom: 1px solid #e2e8f0;
  }

  .tab-btn {
    flex: 1;
    padding: 8px 4px;
    font-size: 12px;
    border: 1px solid #e2e8f0;
    background: #f1f5f9;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-sub);
  }
  .tab-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  #playlist {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .playlist-item {
    padding: 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    cursor: pointer;
    border: 1px solid transparent;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s;
  }

  .playlist-item:hover { background: #f8fafc; }
  
  .playlist-item.active {
    background: var(--active-bg);
    border-color: #bfdbfe;
  }
  
  .playlist-item.done { opacity: 0.5; }

  .item-name { font-size: 14px; font-weight: 600; color: var(--text-main); }
  .item-time { font-size: 12px; color: var(--text-sub); }
  
  /* æ ‡ç­¾æ ·å¼ */
  .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
  .badge-reps { background: #e0f2fe; color: #0284c7; }

  /* ä¸»è§†å›¾ */
  #main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 20px;
  }

  /* è®¡æ—¶å™¨å¡ç‰‡ */
  #timer-card {
    background: white;
    padding: 40px;
    border-radius: 30px;
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
    text-align: center;
    width: 100%;
    max-width: 400px;
    transition: transform 0.3s ease;
  }

  .status-tag {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 20px;
    background: #e2e8f0; color: #475569;
  }
  .status-tag.work { background: #dbeafe; color: #1e40af; }
  .status-tag.rest { background: #dcfce7; color: #166534; }

  #current-action { font-size: 32px; font-weight: 800; margin: 0 0 10px 0; line-height: 1.1; color: var(--text-main); }
  #current-detail { font-size: 18px; color: var(--primary); font-weight: 500; min-height: 27px; }

  #display {
    font-size: 80px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    letter-spacing: -3px;
    margin: 10px 0;
    color: var(--text-main);
    line-height: 1;
  }
  
  #sub-display {
    font-size: 16px;
    color: #94a3b8;
    height: 20px;
    font-weight: 600;
  }

  .controls {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }

  .btn {
    border: none;
    padding: 16px 24px;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    flex: 1;
    transition: transform 0.1s;
    display: flex; align-items: center; justify-content: center;
  }
  .btn:active { transform: scale(0.95); }
  .btn-primary { background: var(--text-main); color: white; flex: 2; }
  .btn-sec { background: #f1f5f9; color: var(--text-main); }

  @media (max-width: 768px) {
    #app-container { flex-direction: column-reverse; }
    #sidebar { width: 100%; height: 40%; border-right: none; border-top: 1px solid #e2e8f0; }
    #main-view { height: 60%; }
    #timer-card { padding: 20px; box-shadow: none; background: transparent; }
    #display { font-size: 72px; }
    #current-action { font-size: 24px; }
  }
</style>
</head>
<body>

<div id="app-container">
  <!-- å·¦ä¾§ -->
  <div id="sidebar">
    <div class="category-tabs">
      <button class="tab-btn" onclick="app.loadCategory('activation')">ğŸ”¥ è·‘å‰æ¿€æ´»</button>
      <button class="tab-btn active" onclick="app.loadCategory('stretch')">ğŸ§˜ è·‘åæ‹‰ä¼¸</button>
      <button class="tab-btn" onclick="app.loadCategory('strength')">ğŸ’ª åŠ›é‡å¼ºåŒ–</button>
    </div>
    <div id="playlist"></div>
  </div>

  <!-- å³ä¾§ -->
  <div id="main-view">
    <div id="timer-card">
      <div id="status-tag" class="status-tag">å‡†å¤‡</div>
      <h1 id="current-action">é€‰æ‹©æ¨¡å¼</h1>
      <div id="current-detail">ç‚¹å‡»å·¦ä¾§åˆ—è¡¨å¼€å§‹</div>
      <div id="display">00.0</div>
      <div id="sub-display"></div> <!-- æ˜¾ç¤ºå€’è®¡æ—¶/æç¤º -->
      
      <div class="controls">
        <button class="btn btn-sec" onclick="app.skip(-1)">â®</button>
        <button class="btn btn-primary" id="toggle-btn" onclick="app.toggle()">å¼€å§‹</button>
        <button class="btn btn-sec" onclick="app.skip(1)">â­</button>
      </div>
      <div style="margin-top:15px; font-size:12px; color:#94a3b8; cursor:pointer;" onclick="app.reset()">æŒ‰ R é‡ç½®</div>
    </div>
  </div>
</div>

<script>
const app = (function() {
  // === æ•°æ®é…ç½® (è¿˜åŸæ‚¨çš„åŸå§‹è®¡åˆ’ + ä¿®æ”¹ä¾§æŠ¬è…¿) ===
  const DATA = {
    // 1. è·‘å‰æ¿€æ´»
    activation: {
      work: 30, rest: 3,
      items: [
        // ä¿®æ”¹ï¼šå¢åŠ  mode:'reps', count:æ¬¡æ•°, interval:å•æ¬¡ç§’æ•°
        // 15æ¬¡ï¼Œæ¯æ¬¡2ç§’ï¼Œå…±30ç§’
        { name: "ç«™å§¿ä¾§æŠ¬è…¿", detail: "å·¦ä¾§", mode: 'reps', count: 15, interval: 1.2 },
        { name: "ç«™å§¿ä¾§æŠ¬è…¿", detail: "å³ä¾§", mode: 'reps', count: 15, interval: 1.2 },
        // åŸå§‹ï¼š
        { name: "é å¢™é™è¹²", detail: "" },
      ]
    },
    // 2. è·‘åæ‹‰ä¼¸ (åŸå§‹æ•°æ®)
    stretch: {
      work: 45, rest: 10,
      items: [
        { name: "è‚¡å››å¤´è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å¤§è…¿å‰ä¾§)" },
        { name: "è‚¡å››å¤´è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å¤§è…¿å‰ä¾§)" },
        { name: "èƒ­ç»³è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å¤§è…¿åä¾§)" },
        { name: "èƒ­ç»³è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å¤§è…¿åä¾§)" },
        { name: "ITB é«‚èƒ«æŸ", detail: "å·¦ä¾§ (åŒè„šäº¤å‰)" },
        { name: "ITB é«‚èƒ«æŸ", detail: "å³ä¾§ (åŒè„šäº¤å‰)" },
        { name: "è…“è‚ è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å°è…¿åä¾§ç›´è…¿)" },
        { name: "è…“è‚ è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å°è…¿åä¾§ç›´è…¿)" },
        { name: "æ¯”ç›®é±¼è‚Œæ‹‰ä¼¸", detail: "å·¦ä¾§ (å°è…¿åä¾§å±ˆè†)" },
        { name: "æ¯”ç›®é±¼è‚Œæ‹‰ä¼¸", detail: "å³ä¾§ (å°è…¿åä¾§å±ˆè†)" }
      ]
    },
    // 3. åŠ›é‡å¼ºåŒ– (åŸå§‹æ•°æ®)
    strength: {
      work: 50, rest: 15,
      items: [
        { name: "é å¢™é™è¹²", detail: "" },
        { name: "é å¢™é™è¹²", detail: "" },
        { name: "é å¢™é™è¹²", detail: "" },
      ]
    }
  };

  // === çŠ¶æ€å˜é‡ ===
  let currentCategory = 'stretch';
  let queue = [];
  let cursor = 0;
  let timeLeft = 0;
  let isRunning = false;
  let rafId = null;
  let lastTime = null;
  let audioCtx = null;
  
  // ä¸“é—¨ç”¨äºRepæ¨¡å¼è®°å½•ä¸Šä¸€å£°æ»´æ˜¯åœ¨ç¬¬å‡ æ¬¡
  let lastBeepRepIndex = 0;

  // === DOM ===
  const els = {
    playlist: document.getElementById('playlist'),
    tabs: document.querySelectorAll('.tab-btn'),
    display: document.getElementById('display'),
    subDisplay: document.getElementById('sub-display'),
    action: document.getElementById('current-action'),
    detail: document.getElementById('current-detail'),
    tag: document.getElementById('status-tag'),
    btnToggle: document.getElementById('toggle-btn')
  };

  function init() {
    loadCategory('activation');
    setupAudio();
  }

  function loadCategory(key) {
    currentCategory = key;
    
    els.tabs.forEach(t => t.classList.remove('active'));
    const targetTab = Array.from(els.tabs).find(t => t.innerText.includes(key==='activation'?'æ¿€æ´»':key==='stretch'?'æ‹‰ä¼¸':'å¼ºåŒ–'));
    if(targetTab) targetTab.classList.add('active');

    const cfg = DATA[key];
    queue = [];
    queue.push({ type: 'prep', name: 'å‡†å¤‡å¼€å§‹', detail: 'è°ƒæ•´å‘¼å¸', duration: 3 });
    
    cfg.items.forEach((item, idx) => {
      // è¿™é‡Œçš„é€»è¾‘ï¼šå¦‚æœæ˜¯æ¬¡æ•°æ¨¡å¼ï¼Œæ—¶é•¿ç”±æ¬¡æ•°å†³å®šï¼›å¦åˆ™ç”±åˆ†ç±»é»˜è®¤å€¼å†³å®š
      let duration = cfg.work;
      let mode = 'time';
      let count = 0, interval = 0;

      if (item.mode === 'reps') {
        mode = 'reps';
        count = item.count;
        interval = item.interval;
        duration = count * interval; // è‡ªåŠ¨è®¡ç®—æ€»æ—¶é•¿
      }

      queue.push({ 
        type: 'work', 
        name: item.name, 
        detail: item.detail, 
        duration: duration, 
        refIndex: idx,
        total: cfg.items.length,
        mode: mode,
        count: count,
        interval: interval
      });

      if (idx < cfg.items.length - 1) {
        queue.push({ 
          type: 'rest', 
          name: 'ä¼‘æ¯', 
          detail: `Next: ${cfg.items[idx+1].name}`, 
          duration: cfg.rest,
          refIndex: idx 
        });
      }
    });
    
    queue.push({ type: 'finish', name: 'è®­ç»ƒå®Œæˆ', detail: 'Nice Work!', duration: 0 });

    cursor = 0;
    isRunning = false;
    timeLeft = queue[0].duration;
    cancelAnimationFrame(rafId);
    renderPlaylist();
    renderUI();
  }

  function renderPlaylist() {
    const items = DATA[currentCategory].items;
    els.playlist.innerHTML = items.map((item, idx) => {
      let extra = "";
      if (item.mode === 'reps') {
        extra = `<span class="badge badge-reps">${item.count}æ¬¡</span>`;
      }
      return `
      <div class="playlist-item" id="pl-item-${idx}" onclick="app.jumpTo(${idx})">
        <div>
          <div class="item-name">${idx + 1}. ${item.name} ${extra}</div>
          <div class="item-time">${item.detail}</div>
        </div>
        <div style="font-size:12px; color:#cbd5e1">${item.mode==='reps' ? (item.count*item.interval) : DATA[currentCategory].work}s</div>
      </div>
    `}).join('');
  }

  function jumpTo(itemIndex) {
    const qIndex = queue.findIndex(q => q.type === 'work' && q.refIndex === itemIndex);
    if (qIndex !== -1) {
      cursor = qIndex;
      timeLeft = queue[cursor].duration;
      lastBeepRepIndex = 0; // é‡ç½®æ»´å£°è®¡æ•°
      if (!isRunning) start();
      else lastTime = performance.now();
      
      speak(queue[cursor].name);
      renderUI();
    }
  }

  function skip(direction) {
    let newCursor = cursor + direction;
    if (direction === 1 && newCursor >= queue.length) return;
    if (direction === -1 && newCursor < 0) return;
    
    cursor = newCursor;
    timeLeft = queue[cursor].duration;
    lastBeepRepIndex = 0; 
    
    if (direction === 1 && !isRunning) start(); 
    else renderUI();
  }

  function toggle() {
    if (queue[cursor].type === 'finish') return;
    initAudioContext(); // å¿…é¡»åœ¨ç‚¹å‡»æ—¶è§¦å‘
    if (isRunning) pause(); else start();
  }

  function start() {
    if (isRunning) return;
    isRunning = true;
    lastTime = performance.now();
    rafId = requestAnimationFrame(tick);
    renderUI();
  }

  function pause() {
    isRunning = false;
    cancelAnimationFrame(rafId);
    renderUI();
  }

  function reset() {
    loadCategory(currentCategory);
  }

  // === è®¡æ—¶æ ¸å¿ƒ ===
  function tick() {
    if (!isRunning) return;
    const now = performance.now();
    const delta = (now - lastTime) / 1000;
    lastTime = now;

    if (timeLeft > 0) {
      const prevTime = timeLeft;
      timeLeft -= delta;
      
      const step = queue[cursor];

      // 1. æ™®é€šå€’è®¡æ—¶æ»´å£° (æœ€å3ç§’)
      if (step.mode !== 'reps') {
         if (Math.ceil(timeLeft) <= 3 && Math.ceil(prevTime) > Math.ceil(timeLeft) && timeLeft > 0) {
            playBeep(600, 0.1); 
         }
      }
      
      // 2. æ¬¡æ•°æ¨¡å¼æ»´å£° (æŒ‰é—´éš”)
      if (step.type === 'work' && step.mode === 'reps') {
         // å·²ç»è¿‡å»çš„æ—¶é—´
         const elapsed = step.duration - timeLeft;
         // å½“å‰åº”è¯¥åœ¨ç¬¬å‡ ä¸ªåŠ¨ä½œ (ä»1å¼€å§‹)
         // ä¾‹å¦‚ interval=2. elapsed=0.1 -> ç¬¬1ä¸ª; elapsed=2.1 -> ç¬¬2ä¸ª
         const currentRep = Math.floor(elapsed / step.interval) + 1;
         
         // å¦‚æœå½“å‰çš„ rep ç¼–å·å˜å¤§äº†ï¼Œè¯´æ˜è¿›å…¥äº†æ–°çš„ä¸€æ¬¡ï¼Œæ»´ä¸€å£°
         // æ³¨æ„ï¼šåˆšå¼€å§‹(currentRep=1)çš„æ—¶å€™ä¹Ÿè¦æ»´
         if (currentRep > lastBeepRepIndex && currentRep <= step.count) {
            lastBeepRepIndex = currentRep;
            playBeep(880, 0.15); // 880Hz æ›´æ¸…è„†ï¼Œ0.15s æ›´é•¿ä¸€ç‚¹
         }
      }

      renderUI();
      rafId = requestAnimationFrame(tick);
    } else {
      autoNext();
    }
  }

  function autoNext() {
    if (cursor >= queue.length - 1) {
      cursor = queue.length - 1;
      pause();
      playWin();
      renderUI();
      return;
    }

    cursor++;
    const step = queue[cursor];
    timeLeft = step.duration;
    lastBeepRepIndex = 0;

    // è¯­éŸ³æ’­æŠ¥
    if (step.type === 'work') {
      playBeep(440, 0.3);
      speak(step.name + (step.mode==='reps' ? "ï¼Œå‡†å¤‡" : ""));
    } else if (step.type === 'rest') {
      playBeep(880, 0.1);
      speak("ä¼‘æ¯");
    }

    lastTime = performance.now();
    rafId = requestAnimationFrame(tick);
    renderUI();
  }

  // === UI æ¸²æŸ“ ===
  function renderUI() {
    const step = queue[cursor];
    
    // æ˜¾ç¤ºé€»è¾‘åŒºåˆ†
    if (step.type === 'work' && step.mode === 'reps') {
       // æ¬¡æ•°æ¨¡å¼ï¼šæ˜¾ç¤ºæ¬¡æ•°
       const currentRep = Math.max(1, Math.min(step.count, lastBeepRepIndex || 1));
       els.display.innerText = `${currentRep} / ${step.count}`;
       els.subDisplay.innerText = "è·ŸéšèŠ‚å¥";
    } else {
       // æ—¶é—´æ¨¡å¼ï¼šæ˜¾ç¤ºç§’æ•°
       els.display.innerText = Math.max(0.0, timeLeft).toFixed(1);
       els.subDisplay.innerText = "";
    }

    els.action.innerText = step.name;
    els.detail.innerText = step.detail;
    els.btnToggle.innerText = isRunning ? "æš‚åœ" : (step.type === 'finish' ? "ç»“æŸ" : "å¼€å§‹");
    
    document.body.style.background = step.type === 'rest' ? '#f0fdf4' : '#f8fafc';
    
    if (step.type === 'work') {
      els.tag.className = 'status-tag work';
      els.tag.innerText = `è®­ç»ƒä¸­ ${step.refIndex+1}/${step.total}`;
      els.display.style.color = '#0f172a';
    } else if (step.type === 'rest') {
      els.tag.className = 'status-tag rest';
      els.tag.innerText = 'Rest';
      els.display.style.color = '#166534';
    } else {
      els.tag.className = 'status-tag';
      els.tag.innerText = step.type === 'prep' ? 'Ready' : 'Done';
      els.display.style.color = '#0f172a';
    }

    document.querySelectorAll('.playlist-item').forEach(d => {
        d.classList.remove('active'); d.classList.remove('done');
    });
    
    let targetIdx = -1;
    if (step.type === 'work') targetIdx = step.refIndex;
    else if (step.type === 'rest') targetIdx = queue[cursor+1]?.refIndex;
    
    if (targetIdx !== undefined && targetIdx !== -1) {
       const el = document.getElementById(`pl-item-${targetIdx}`);
       if (el) {
           el.classList.add('active');
           el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
       }
       for(let i=0; i<targetIdx; i++) {
          const prev = document.getElementById(`pl-item-${i}`);
          if(prev) prev.classList.add('done');
       }
    }
  }

  // === éŸ³é¢‘ç³»ç»Ÿ ===
  function setupAudio() {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
  }
  
  function initAudioContext() {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function playBeep(freq, dur) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    
    // å¢åŠ éŸ³é‡ (0.5æ¯”ä¹‹å‰çš„0.1å¤§å¾ˆå¤š)
    gain.gain.setValueAtTime(1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
  }

  function playWin() {
    if (!audioCtx) return;
    [400, 600, 800].forEach((f, i) => setTimeout(() => playBeep(f, 0.2), i*150));
    speak("è®­ç»ƒå®Œæˆ");
  }

  function speak(txt) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(txt);
      msg.lang = 'zh-CN';
      msg.rate = 1.2;
      window.speechSynthesis.speak(msg);
    }
  }

  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); toggle(); }
    else if (e.code === 'ArrowRight') skip(1);
    else if (e.code === 'ArrowLeft') skip(-1);
    else if (e.key.toLowerCase() === 'r') reset();
  });

  init();

  return { loadCategory, jumpTo, toggle, skip, reset };
})();
</script>
</body>
</html>